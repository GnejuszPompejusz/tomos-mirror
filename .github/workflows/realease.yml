name: Build Release APK

on:
    push:
        tags: ["v*"]

    workflow_dispatch:
        inputs:
            versionName:
                description: "Version name (e.g. 1.2.0)"
                required: true
                type: string
            versionCode:
                description: "Version code (e.g. 12)"
                required: true
                type: string

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  flutter-version: 3.38.5
                  cache: true

            - name: Restore keystore for Gradle
              run: |
                  mkdir -p android/app
                  echo "${{ secrets.FDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release-key.p12

            - name: Build release APK
              env:
                  KEYSTORE_PASSWORD: ${{ secrets.FDROID_KEYSTORE_PASS }}
                  KEY_ALIAS: release
              run: |
                  flutter pub get
                  flutter build apk --release --split-per-abi

            - name: Upload APKs
              uses: actions/upload-artifact@v4
              with:
                  name: release-apk
                  path: build/app/outputs/flutter-apk/*.apk
