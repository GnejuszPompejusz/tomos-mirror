name: Build & Publish F-Droid Repo NEW

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      versionName:
        description: "App version name"
        required: true
      versionCode:
        description: "Android versionCode"
        required: true
      flutterVersion:
        description: "Flutter version"
        required: false
        default: 3.38.5

jobs:
  fdroid:
    runs-on: ubuntu-latest
    env:
      APPID: dev.gnejusz.tomos
      FLUTTER_VERSION: ${{ inputs.flutterVersion || '3.38.5' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Increase Git buffer limits
        run: |
          git config --global fetch.fsckobjects false
          git config --global http.postBuffer 524288000
          git config --global http.maxRequestBuffer 1000M
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install fdroidserver
        run: |
          sudo apt update
          sudo apt install -y fdroidserver libglu1-mesa

      - name: Resolve version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION_NAME=${{ inputs.versionName }}" >> $GITHUB_ENV
            echo "VERSION_CODE=${{ inputs.versionCode }}" >> $GITHUB_ENV
          else
            TAG=${GITHUB_REF#refs/tags/}
            echo "VERSION_NAME=${TAG#v}" >> $GITHUB_ENV
            echo "VERSION_CODE=${{ github.run_number }}" >> $GITHUB_ENV
          fi

      - name: Get commit SHA
        run: echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Prepare keystore
        run: |
          test -f fdroid/keystore.properties.template || \
            (echo "Brak fdroid/keystore.properties.template" && exit 1)

          echo "${{ secrets.FDROID_KEYSTORE_BASE64 }}" | base64 -d > fdroid/release-key.p12

          sed "s/__FDROID_KEYSTORE_PASS__/${{ secrets.FDROID_KEYSTORE_PASS }}/g" \
            fdroid/keystore.properties.template > fdroid/keystore.properties

      - name: Generate changelog
        run: |
          mkdir -p "fdroid/metadata/$APPID/changelogs"
          git log --pretty=format:"- %s" -n 50 > "fdroid/metadata/$APPID/changelogs/$VERSION_CODE.txt"

      - name: Patch metadata
        run: |
          METADATA="fdroid/metadata/$APPID.yml"
          mkdir -p fdroid/metadata

          if [ ! -f "$METADATA" ]; then
            echo "Builds:" > "$METADATA"
          fi

          if ! grep -q "versionName: \"$VERSION_NAME\"" "$METADATA"; then
            cat >> "$METADATA" <<'EOF'
          - versionName: "__VERSION_NAME__"
            versionCode: __VERSION_CODE__
            commit: __COMMIT__
            subdir: .
            init: |
              cp fdroid/keystore.properties android/keystore.properties
              cp fdroid/release-key.p12 android/release-key.p12
              flutter pub get
            gradle:
              - assembleRelease
            output:
              - app/build/outputs/apk/release/app-release.apk
            EOF
                    sed -i "s/__VERSION_NAME__/$VERSION_NAME/g" "$METADATA"
                    sed -i "s/__VERSION_CODE__/$VERSION_CODE/g" "$METADATA"
                    sed -i "s/__COMMIT__/$COMMIT/g" "$METADATA"
                  fi

                  if ! grep -q "^AllowedAPKSigningKeys:" "$METADATA"; then
                    cat >> "$METADATA" <<'EOF'

          AllowedAPKSigningKeys:
          - 1DCD14A7A1636623F211331784878A06D692F6747382AA79684668402C7094EE
          EOF
                  fi
      - name: Debug metadata
        run: |
          echo "===== METADATA FILE ====="
          cat fdroid/metadata/$APPID.yml
          echo "========================="

      - name: fdroid build
        run: |
          cd fdroid
          fdroid build --verbose "$APPID:$VERSION_NAME"

      - name: fdroid verify
        run: |
          cd fdroid
          fdroid verify --verbose "$APPID:$VERSION_NAME"

      - name: fdroid update
        run: |
          cd fdroid
          fdroid update --verbose
