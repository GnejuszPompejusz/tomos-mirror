name: Build & Publish F-Droid Repo

on:
  push:
    tags: [ "v*" ]

  workflow_dispatch:
    inputs:
      versionName:
        description: "App version name (e.g. 1.2.0)"
        required: true
      versionCode:
        description: "Android versionCode (e.g. 12)"
        required: true
      flutterVersion:
        description: "Flutter version (e.g. 3.38.5)"
        required: false
        default: 3.38.5   # Aktualna stable na styczeń 2026

jobs:
  fdroid:
    runs-on: ubuntu-latest
    env:
      APPID: com.gnejusz.tomos   # ⚠️ ZMIEŃ NA RZECZYWISTY PACKAGE NAME Z android/app/build.gradle
      FLUTTER_VERSION: ${{ inputs.flutterVersion || '3.38.5' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install fdroidserver and dependencies
        run: |
          sudo apt update
          sudo apt install -y fdroidserver libglu1-mesa

      - name: Clean build environment (for reproducibility)
        run: |
          rm -rf ~/.gradle ~/.android ~/.cache || true

      - name: Flutter doctor (diagnostics)
        run: flutter doctor -v

      - name: Resolve version and commit
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION_NAME=${{ inputs.versionName }}" >> $GITHUB_ENV
            echo "VERSION_CODE=${{ inputs.versionCode }}" >> $GITHUB_ENV
            echo "COMMIT=${{ github.sha }}" >> $GITHUB_ENV
          else
            TAG=${GITHUB_REF#refs/tags/}
            echo "VERSION_NAME=${TAG#v}" >> $GITHUB_ENV
            echo "VERSION_CODE=$(echo ${TAG#v} | tr -d '.')" >> $GITHUB_ENV
            echo "COMMIT=$TAG" >> $GITHUB_ENV
          fi

      - name: Restore keystore
        run: |
          mkdir -p fdroid
          echo "${{ secrets.FDROID_KEYSTORE_BASE64 }}" | base64 -d > fdroid/keystore.p12

      - name: Generate changelog
        run: |
          mkdir -p fdroid/metadata/${{ env.APPID }}/changelogs
          if git describe --tags --abbrev=0 HEAD^ >/dev/null 2>&1; then
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^)
            git log --pretty=format:"- %s" \( PREV_TAG..HEAD > fdroid/metadata/ \){{ env.APPID }}/changelogs/${{ env.VERSION_CODE }}.txt
          else
            git log --pretty=format:"- %s" > fdroid/metadata/\( {{ env.APPID }}/changelogs/ \){{ env.VERSION_CODE }}.txt
          fi

      - name: Patch metadata – append new build (preserve history)
        run: |
          METADATA=fdroid/metadata/${{ env.APPID }}.yml
          
          if ! grep -q "^Builds:" "$METADATA"; then
            echo "" >> "$METADATA"
            echo "Builds:" >> "$METADATA"
          fi
          
          if grep -q "versionName: ${{ env.VERSION_NAME }}" "$METADATA"; then
            echo "Wersja ${{ env.VERSION_NAME }} już istnieje – pomijam append."
          else
            cat <<EOF >> "$METADATA"
              - versionName: ${{ env.VERSION_NAME }}
                versionCode: ${{ env.VERSION_CODE }}
                commit: ${{ env.COMMIT }}
                subdir: .
                init: |
                  export LANG=C.UTF-8
                  export LC_ALL=C.UTF-8
                  rm -rf ~/.gradle/caches || true
                  flutter pub get
                  flutter build apk --release --split-per-abi
                gradle: []
                output:
                  - build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
                  - build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
                  - build/app/outputs/flutter-apk/app-x86_64-release.apk
            EOF
          fi
          
          if ! grep -q "^AllowedAPKSigningKeys:" "$METADATA"; then
            cat <<EOF >> "$METADATA"
          
          AllowedAPKSigningKeys:
            - SHA256:TWÓJ_SHA256_TUTAJ   # keytool -list -v -keystore keystore.p12 -storetype PKCS12 | grep SHA256
          EOF
          fi

      - name: Build and sign app with fdroid build
        env:
          FDROID_KEYSTORE: keystore.p12
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
          FDROID_KEY_PASS: ${{ secrets.FDROID_KEY_PASS }}
        run: |
          cd fdroid
          fdroid build --verbose \( {{ env.APPID }}: \){{ env.VERSION_NAME }}

      - name: Verify reproducibility
        env:
          FDROID_KEYSTORE: keystore.p12
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
          FDROID_KEY_PASS: ${{ secrets.FDROID_KEY_PASS }}
        run: |
          cd fdroid
          fdroid verify --verbose \( {{ env.APPID }}: \){{ env.VERSION_NAME }}

      - name: Update repo index
        env:
          FDROID_KEYSTORE: keystore.p12
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
          FDROID_KEY_PASS: ${{ secrets.FDROID_KEY_PASS }}
        run: |
          cd fdroid
          fdroid update --verbose

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: fdroid/repo
          publish_branch: gh-pages
