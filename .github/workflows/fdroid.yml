name: Build & Publish F-Droid Repo

on:
  push:
    tags: ["v*"]

  workflow_dispatch:
    inputs:
      versionName:
        description: "App version name (e.g. 1.2.0)"
        required: true
      versionCode:
        description: "Android versionCode (e.g. 12)"
        required: true
      flutterVersion:
        description: "Flutter version (e.g. 3.38.5)"
        required: false
        default: 3.38.5

jobs:
  fdroid:
    runs-on: ubuntu-latest
    env:
      APPID: com.gnejusz.tomos
      FLUTTER_VERSION: ${{ inputs.flutterVersion || '3.38.5' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Increase Git buffer limits (fix GitLab clone issues)
        run: |
          git config --global fetch.fsckobjects false
          git config --global http.postBuffer 524288000
          git config --global http.maxRequestBuffer 1000M
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install fdroidserver and deps
        run: |
          sudo apt update
          sudo apt install -y fdroidserver libglu1-mesa

      - name: Clean build env
        run: |
          rm -rf ~/.gradle ~/.android ~/.cache || true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get GitLab commit
        run: |
          SHA=$(git ls-remote https://gitlab.com/gnejusz_pompejusz/tomos.git HEAD | cut -f1)
          echo "COMMIT=$SHA" >> $GITHUB_ENV

      - name: Resolve version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION_NAME=${{ inputs.versionName }}" >> $GITHUB_ENV
            echo "VERSION_CODE=${{ inputs.versionCode }}" >> $GITHUB_ENV
          else
            TAG=${GITHUB_REF#refs/tags/}
            echo "VERSION_NAME=${TAG#v}" >> $GITHUB_ENV
            echo "VERSION_CODE=$(echo ${TAG#v} | tr -d '.')" >> $GITHUB_ENV
          fi

      - name: Create F-Droid keystore
        run: |
          mkdir -p fdroid
          echo "${{ secrets.FDROID_KEYSTORE_BASE64 }}" | base64 -d > fdroid/keystore.p12

      - name: Generate changelog
        run: |
          mkdir -p "fdroid/metadata/$APPID/changelogs"

          if git describe --tags --abbrev=0 HEAD^ >/dev/null 2>&1; then
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^)
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD \
              > "fdroid/metadata/$APPID/changelogs/$VERSION_CODE.txt"
          else
            git log --pretty=format:"- %s" \
              > "fdroid/metadata/$APPID/changelogs/$VERSION_CODE.txt"
          fi

      - name: Patch metadata
        run: |
          METADATA="fdroid/metadata/$APPID.yml"

          # Dodaj sekcję Builds: jeśli nie istnieje
          if ! grep -q "^Builds:" "$METADATA"; then
            echo "" >> "$METADATA"
            echo "Builds:" >> "$METADATA"
          fi

          # Dodaj nową wersję jeśli jeszcze nie ma takiej versionName
           if ! grep -q "versionName: $VERSION_NAME" "$METADATA"; then
            echo "  - versionName: \"$VERSION_NAME\"" >> "$METADATA"
            echo "    versionCode: $VERSION_CODE" >> "$METADATA"
            echo "    commit: $COMMIT" >> "$METADATA"
            echo "    subdir: ." >> "$METADATA"
            echo "    prebuild:" >> "$METADATA"
            echo "      # DEBUG: Stan przed" >> "$METADATA"
            echo "      - echo \"=== DEBUG PRE: keystore.properties ===\"" >> "$METADATA"
            echo "      - ls -la keystore.properties key.properties || true" >> "$METADATA"
            echo "      - cat keystore.properties || echo \"brak\"" >> "$METADATA"
            echo "      # Tworzymy pusty keystore.properties, żeby uniknąć fallbacka '../../release-key.p12'" >> "$METADATA"
            echo "      - touch keystore.properties" >> "$METADATA"
            echo "      - echo \"KEYSTORE_PATH=\" >> keystore.properties" >> "$METADATA"
            echo "      - echo \"KEYSTORE_PASSWORD=\" >> keystore.properties" >> "$METADATA"
            echo "      - echo \"KEY_ALIAS=\" >> keystore.properties" >> "$METADATA"
            echo "      # Zmieniamy release signing na debug (debug keystore zawsze istnieje i nie wymaga haseł)" >> "$METADATA"
            echo "      - sed -i 's/signingConfig signingConfigs.release/signingConfig signingConfigs.debug/g' android/app/build.gradle || true" >> "$METADATA"
            echo "      # DEBUG: Stan po" >> "$METADATA"
            echo "      - echo \"=== DEBUG POST: keystore.properties ===\"" >> "$METADATA"
            echo "      - cat keystore.properties" >> "$METADATA"
            echo "      - echo \"=== DEBUG POST: buildTypes ===\"" >> "$METADATA"
            echo "      - grep -n -A5 -B5 buildTypes android/app/build.gradle || true" >> "$METADATA"
            echo "    init: |" >> "$METADATA"
            echo "      export LANG=C.UTF-8" >> "$METADATA"
            echo "      export LC_ALL=C.UTF-8" >> "$METADATA"
            echo "      rm -rf ~/.gradle/caches || true" >> "$METADATA"
            echo "      flutter pub get" >> "$METADATA"
            echo "      flutter build apk --release --split-per-abi" >> "$METADATA"
            echo "    gradle: []" >> "$METADATA"
            echo "    output:" >> "$METADATA"
            echo "      - build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk" >> "$METADATA"
            echo "      - build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" >> "$METADATA"
            echo "      - build/app/outputs/flutter-apk/app-x86_64-release.apk" >> "$METADATA"
          fi

          # Dodaj AllowedAPKSigningKeys jeśli nie istnieje
          if ! grep -q "^AllowedAPKSigningKeys:" "$METADATA"; then
            echo "" >> "$METADATA"
            echo "AllowedAPKSigningKeys:" >> "$METADATA"
            echo "  - 1DCD14A7A1636623F211331784878A06D692F6747382AA79684668402C7094EE" >> "$METADATA"
          fi
      - name: Debug keystore paths
        run: |
          echo "=== CURRENT DIR ==="
          pwd

          echo "=== LIST ROOT ==="
          ls -R .

          echo "=== LIST fdroid ==="
          ls -R fdroid || true

          echo "=== LIST fdroid/build ==="
          ls -R fdroid/build || true

          echo "=== LIST fdroid/build/com.gnejusz.tomos ==="
          ls -R fdroid/build/com.gnejusz.tomos || true

          echo "=== CHECK FILE ==="
          if [ -f fdroid/keystore.p12 ]; then
            echo "FOUND fdroid/keystore.p12"
          else
            echo "NOT FOUND fdroid/keystore.p12"
          fi
      - name: Debug before fdroid build
        run: |
          echo "=== DEBUG PRZED fdroid build ==="
          echo "Current dir:"
          pwd
          echo "ls -la fdroid/"
          ls -la fdroid/
          echo "=== fdroid/keystore.p12 istnieje? ==="
          if [ -f fdroid/keystore.p12 ]; then
            echo "ZNALEZIONO keystore.p12"
            echo "(rozmiar: $(stat -c%s fdroid/keystore.p12) bajtów)"
          else
            echo "NIE ZNALEZIONO keystore.p12"
          fi
          echo "=== Finalny metadata.yml ==="
          cat fdroid/metadata/com.gnejusz.tomos.yml
          echo "=== Koniec debug przed build ==="
      - name: fdroid build
        env:
          FDROID_KEYSTORE: keystore.p12
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
          FDROID_KEY_PASS: ${{ secrets.FDROID_KEY_PASS }}
        run: |
          cd fdroid
          fdroid build --verbose "$APPID:$VERSION_NAME"

      - name: fdroid verify
        env:
          FDROID_KEYSTORE: keystore.p12
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
          FDROID_KEY_PASS: ${{ secrets.FDROID_KEY_PASS }}
        run: |
          cd fdroid
          fdroid verify --verbose "$APPID:$VERSION_NAME"

      - name: fdroid update
        env:
          FDROID_KEYSTORE: keystore.p12
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
          FDROID_KEY_PASS: ${{ secrets.FDROID_KEY_PASS }}
        run: |
          cd fdroid
          fdroid update --verbose

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: fdroid/repo
          publish_branch: gh-pages
