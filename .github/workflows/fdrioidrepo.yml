name: Build & Publish F-Droid Repo 3

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      versionName:
        description: "App version name (np. 1.0.0)"
        required: true
      versionCode:
        description: "Android versionCode (np. 10)"
        required: true
      flutterVersion:
        description: "Flutter version"
        required: false
        default: "3.24.5"

jobs:
  fdroid:
    runs-on: ubuntu-latest
    env:
      APPID: dev.gnejusz.tomos
      GITLAB_URL: "https://gitlab.com/gnejusz_pompejusz/tomos.git"
      FLUTTER_VERSION: ${{ github.event.inputs.flutterVersion || '3.24.5' }}

    steps:
      - name: Checkout Hosting Repo (GitHub)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install fdroidserver
        run: |
          sudo apt update
          sudo apt install -y fdroidserver libglu1-mesa python3-pip
          pip3 install --upgrade fdroidserver

      - name: Clone Source & Resolve Version
        id: version
        run: |
          git clone --depth 1 ${{ env.GITLAB_URL }} source_code
          cd source_code
          echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION_NAME=${{ github.event.inputs.versionName }}" >> $GITHUB_ENV
            echo "VERSION_CODE=${{ github.event.inputs.versionCode }}" >> $GITHUB_ENV
          else
            TAG=${GITHUB_REF#refs/tags/}
            echo "VERSION_NAME=${TAG#v}" >> $GITHUB_ENV
            # Eksportuj versionCode z pubspec.yaml lub uÅ¼yj run_number
            VERSION_CODE=$(grep "version:" pubspec.yaml | head -1 | sed 's/.*+//' || echo "${{ github.run_number }}")
            echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV
          fi

      - name: Build Release APK
        run: |
          cd source_code
          flutter pub get
          flutter build apk --release
          mkdir -p $GITHUB_WORKSPACE/apks
          cp build/app/outputs/flutter-apk/app-release.apk $GITHUB_WORKSPACE/apks/${{ env.APPID }}_${{ env.VERSION_CODE }}.apk

      - name: Setup Signing
        run: |
          cd source_code
          
          cat > android/keystore.properties <<EOF
          storePassword=${{ secrets.FDROID_KEYSTORE_PASS }}
          keyPassword=${{ secrets.FDROID_KEYSTORE_PASS }}
          keyAlias=fdroid
          storeFile=release-key.jks
          EOF

          mkdir -p android/app
          echo "${{ secrets.FDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release-key.jks
          
          keytool -list -v -keystore android/app/release-key.jks \
            -storepass ${{ secrets.FDROID_KEYSTORE_PASS }} -alias fdroid -q

      - name: Init F-Droid Structure (if needed)
        run: |
          if [ ! -d "fdroid" ]; then
            mkdir -p fdroid/repo fdroid/metadata
            fdroid init || true
          fi

      - name: Update Metadata
        run: |
          METADATA="$GITHUB_WORKSPACE/fdroid/metadata/${{ env.APPID }}.yml"
          
          mkdir -p "$GITHUB_WORKSPACE/fdroid/metadata/${{ env.APPID }}"
          
          if [ ! -f "$METADATA" ]; then
            cat > "$METADATA" <<EOF
          Categories:
            - Internet
          License: GPL-3.0-only
          SourceCode: https://gitlab.com/gnejusz_pompejusz/tomos
          IssueTracker: https://gitlab.com/gnejusz_pompejusz/tomos/-/issues
          Name: Tomos
          Summary: A philosophical scroll for Librus Synergia
          Description: |
            In the grand agora of modern education, where the Polish platform Librus Synergia reigns like an oracle both revered and confounding, Tomos emerges as a humble yet defiant tool.
            Crafted in the spirit of ancient Greece, it brings clarity to the bureaucratic labyrinth of grades, messages, and school decrees.
            Unofficial, open-source, and built with Flutter and Riverpod.
          RepoType: git
          Repo: https://gitlab.com/gnejusz_pompejusz/tomos.git
          
          Builds:
          EOF
          fi

          if ! grep -q "versionCode: ${{ env.VERSION_CODE }}" "$METADATA"; then
            cat >> "$METADATA" <<EOF
            - versionName: ${{ env.VERSION_NAME }}
              versionCode: ${{ env.VERSION_CODE }}
              commit: ${{ env.COMMIT }}
              subdir: source_code
              gradle:
                - yes
          EOF
          fi

      - name: Update F-Droid Index
        env:
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
        run: |
          cp apks/*.apk fdroid/repo/
          cd fdroid
          fdroid update --pretty --verbose
          fdroid sign --verbose

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./fdroid
          destination_dir: .
          keep_files: true