name: Build & Publish F-Droid Repository

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      versionName:
        description: "App version name (np. 1.0.0)"
        required: true
      versionCode:
        description: "Android versionCode (np. 10)"
        required: true
      flutterVersion:
        description: "Flutter version"
        required: false
        default: "stable"

jobs:
  fdroid:
    runs-on: ubuntu-latest
    permissions:             # <-- DODAJ TO
      contents: write
      pages: write
      id-token: write
    env:
      APPID: dev.gnejusz.tomos
      GITLAB_URL: "https://gitlab.com/gnejusz_pompejusz/tomos.git"
      FLUTTER_VERSION: ${{ github.event.inputs.flutterVersion || 'stable' }}
    steps:
      - name: Checkout Hosting Repo (GitHub)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false 
          clean: true       
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION || 'stable' }}
          cache: true

      - name: Install fdroidserver
        run: |
          sudo apt update
          sudo apt install -y fdroidserver libglu1-mesa python3-pip
          pip3 install --upgrade fdroidserver
      - name: Install latest androguard (fixes res1 must be zero error)
        run: pip3 install --upgrade androguard

      - name: Clone Source & Resolve Version
        id: version
        run: |
          git clone --depth 1 ${{ env.GITLAB_URL }} source_code
          cd source_code
          echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION_NAME=${{ github.event.inputs.versionName }}" >> $GITHUB_ENV
            echo "VERSION_CODE=${{ github.event.inputs.versionCode }}" >> $GITHUB_ENV
          else
            TAG=${GITHUB_REF#refs/tags/}
            echo "VERSION_NAME=${TAG#v}" >> $GITHUB_ENV
            # Eksportuj versionCode z pubspec.yaml lub użyj run_number
            VERSION_CODE=$(grep "version:" pubspec.yaml | head -1 | sed 's/.*+//' || echo "${{ github.run_number }}")
            echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV
          fi
      - name: Setup Signing
        run: |
          cd source_code
          
          cat > android/keystore.properties <<EOF
          KEYSTORE_PASSWORD=${{ secrets.FDROID_KEYSTORE_PASS }}
          KEY_ALIAS=fdroid
          KEYSTORE_PATH=../../release-key.p12
          EOF


          echo "${{ secrets.FDROID_KEYSTORE_BASE64 }}" | base64 -d > release-key.p12
          
          keytool -list -v -keystore release-key.p12 \
            -storepass ${{ secrets.FDROID_KEYSTORE_PASS }} -alias fdroid
          # Debug 
          echo "===== keystore.properties =====" 
          cat android/keystore.properties
          echo "===== files in source_code ====="
          ls -l
      - name: Build Release APK
        run: |
          cd source_code
          flutter pub get
          flutter build apk --release 
          mkdir -p $GITHUB_WORKSPACE/apks
          cp build/app/outputs/flutter-apk/app-release.apk $GITHUB_WORKSPACE/apks/${{ env.APPID }}_${{ env.VERSION_CODE }}.apk

      - name: Check APK signature
        run: |
          cd source_code
          apksigner verify --print-certs build/app/outputs/flutter-apk/app-release.apk

      - name: Init F-Droid Structure
        run: |
          mkdir -p repo/icons metadata
          # Tworzymy pustą ikonę, aby fdroid update nie wyrzucał ostrzeżenia
          touch repo/icons/icon.png
          
          # Tworzymy czysty config.yml z POPRAWNYMI nazwami kluczy
          cat > config.yml <<EOF
          keystore: "keystore.p12"
          keystorepass: "${{ secrets.FDROID_KEYSTORE_PASS }}"
          keypass: "${{ secrets.FDROID_KEYSTORE_PASS }}"
          keyalias: "fdroid"
          repo_keyalias: "fdroid"
          repo_url: "https://gnejuszpompejusz.github.io/tomos-mirror/repo"
          repo_name: "Tomos Mirror"
          repo_description: "Repozytorium aplikacji Tomos"
          EOF
          # F-Droid wymaga restrykcyjnych uprawnień dla plików z hasłami
          chmod 600 config.yml

      - name: Setup Repo Signing Key
        run: cp source_code/release-key.p12 keystore.p12

      - name: Update Metadata
        run: |
          mkdir -p metadata/${{ env.APPID }}/en-US/images/screenshots
          mkdir -p repo/icons-160

          # 1. Kopiujemy Twój bogaty opis z folderu źródłowego do katalogu roboczego F-Droida
          cp fdroid/metadata/${{ env.APPID }}.yml metadata/${{ env.APPID }}.yml
          
          # 2. Używamy 'sed', aby podmienić wersje na te aktualnie zbudowane
          # To sprawi, że w aplikacji F-Droid zawsze będzie widać poprawny numer
          sed -i "s/CurrentVersion:.*/CurrentVersion: ${{ env.VERSION_NAME }}/" metadata/${{ env.APPID }}.yml
          sed -i "s/CurrentVersionCode:.*/CurrentVersionCode: ${{ env.VERSION_CODE }}/" metadata/${{ env.APPID }}.yml
          # 3. Skopiuj opisy i grafikę z Twojego katalogu źródłowego
        
          cp -a fdroid/metadata/${{ env.APPID }}/en-US/. metadata/${{ env.APPID }}/en-US/
          
          # 4. Upewnij się, że ikona jest tam, gdzie F-Droid jej szuka (w images/)
          # Jeśli masz ikonę w assets, skopiuj ją do struktury Fastlane
          cp source_code/assets/icons/icon.png metadata/${{ env.APPID }}/en-US/images/icon.png
          
          # Dodatkowo warto skopiować ikonę do folderu repo (klasyczna metoda)
          cp source_code/assets/icons/icon.png repo/icons-160/${{ env.APPID }}.png

      - name: Update F-Droid Index
        env:
          FDROID_KEYSTORE_PASS: ${{ secrets.FDROID_KEYSTORE_PASS }}
        run: |
          cp apks/*.apk repo/
          # fdroid update automatycznie użyje config.yml i podpisze repozytorium
          fdroid update --pretty --verbose

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          destination_dir: repo
          keep_files: false        
          